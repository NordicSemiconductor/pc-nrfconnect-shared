name: Release shared - Helper workflow

# This workflow is intended to be invoked by other workflows.
# It is no longer meant to be invoked directly.

on:
    workflow_call:
        inputs:
            ref:
                description:
                    Ref (Tag, branch, commit SHA) to release. Defaults to from
                    where the workflow is triggered, usually the main branch.
                required: false
                type: string

concurrency:
    group: ${{ github.workflow }}

jobs:
    release:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            id-token: write
        env:
            GH_TOKEN: ${{ github.token }}
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ inputs.ref }}
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: https://registry.npmjs.org
                  cache: npm

            - name: Check if release is possible
              run: |
                  if ! reason=$(npx tsx ./scripts/is-releasable.ts); then
                    echo "ðŸ›‘ Unable to release: $reason" >> $GITHUB_STEP_SUMMARY
                    exit 1
                  fi

            - run: npm install --global npm@latest
            - run: npm ci
            - run: npm run check
            - run: npm test
            - run: npm pack

            - name: Extract release notes
              run:
                  npx tsx ./scripts/latest-changelog-entry.ts > release_notes.md

            - name: Determine next version
              id: determine-next-version
              uses: actions/github-script@v7
              with:
                  script: |
                      const version = require('./package.json').version.replace('.0.0', '');
                      core.setOutput('version', version);
                      core.setOutput('tag', `v${version}`);

            - name: Create GitHub release
              run: |
                  gh release create "${{ steps.determine-next-version.outputs.tag }}" \
                    --title "${{ steps.determine-next-version.outputs.tag }}" \
                    --notes-file release_notes.md

            - name: Publish to npm
              run: |
                  npm publish

                  echo "âœ… Successfully released package [pc-nrfconnect-shared@${{ steps.determine-next-version.outputs.version }}](https://www.npmjs.com/package/@nordicsemiconductor/pc-nrfconnect-shared/v/${{ steps.determine-next-version.outputs.version }}.0.0) to npm." >> $GITHUB_STEP_SUMMARY
